<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Creator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f5f5f5; color: #333; }
        .no-js { display: none; }
        .header { background-color: #1DA1F2; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .nav { display: flex; gap: 20px; }
        .warning { color: red; font-weight: bold; padding: 10px; border: 1px solid red; margin: 10px; background: white; }
        .section { margin: 20px; }
        .section h2 { color: #1DA1F2; }
        .public-bots-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .bot-card { background: white; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); padding: 10px; text-align: center; }
        .bot-avatar { width: 80px; height: 80px; border-radius: 50%; background: #1DA1F2; margin: 0 auto 10px; }
        .category-header { background: #1DA1F2; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; border-radius: 5px 5px 0 0; }
        .control-buttons { display: flex; gap: 10px; }
        .control-btn { padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; }
        .stop-btn { background: #f44336; color: white; }
        .start-btn { background: #4caf50; color: white; }
        .view-logs-btn { background: #9e9e9e; color: white; }
        .category-card { background: white; margin: 10px 0; border-radius: 0 0 5px 5px; padding: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .category-name { font-weight: bold; }
        .category-actions { display: flex; gap: 10px; }
        .settings-btn { background: #ff9800; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; }
        .add-bot-btn { background: #4caf50; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 15% auto; padding: 20px; border-radius: 5px; width: 80%; max-width: 400px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .settings { display: none; background: white; color: black; padding: 10px; border: 1px solid #ccc; margin-top: 10px; border-radius: 5px; }
        #botDisplay { margin: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px; }
    </style>
    <noscript>
        <div class="no-js">
            Epic Games<br>You need to enable JavaScript to run this app.
        </div>
    </noscript>
</head>
<body>
    <div class="header">
        <div class="nav">
            <span>Home</span>
            <span>Bots & Account</span>
        </div>
        <h1>Bot Creator</h1>
    </div>

    <div class="warning">
        Please do not add this to your main account as this may cause major issues with your main account. Please login to an alt account on Epic Games before proceeding with this step.
    </div>

    <div class="section">
        <h2>Public Bots</h2>
        <div id="publicBotsGrid" class="public-bots-grid"></div>
    </div>

    <div class="section">
        <div class="category-header">
            <h3>Home > My Bots</h3>
            <div class="control-buttons">
                <button class="view-logs-btn control-btn" onclick="viewLogs()">View logs</button>
                <button class="stop-btn control-btn" onclick="stopBots()">Stop</button>
                <button class="start-btn control-btn" onclick="startBots()">Start bots</button>
            </div>
        </div>
        <div style="background: #1DA1F2; color: white; padding: 10px; display: flex; justify-content: space-between;">
            <span>Showing 1 categories with 0 bots</span>
            <div>
                <button onclick="sortBots()">Sort by: Available First</button>
                <input type="text" placeholder="Search for a bot...">
            </div>
        </div>
        <div id="categoryList"></div>
    </div>

    <div id="botDisplay"></div>

    <!-- Add Bot Modal -->
    <div id="addBotModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>Add Bot</h3>
            <form id="addBotForm">
                <input type="hidden" id="selectedCategoryId" name="categoryId" value="67c2fd571906bd75e5239684">
                <p>Choose an option:</p>
                <button type="button" onclick="createEpicAccount()">Create Epic Games Account</button>
                <button type="button" onclick="redirectToEpic()">I Already Have an Epic Games Account</button>
                <div id="epicIdField" style="display: none;">
                    <label for="epicId">Epic Games ID (from redirect):</label>
                    <input type="text" id="epicId" name="epicId" placeholder="Enter ID..." required>
                </div>
                <label for="botName">Bot Nickname:</label>
                <input type="text" id="botName" name="botName" placeholder="Enter bot name..." required>
                <button type="submit" id="submitBtn" style="display: none;">Add Bot</button>
            </form>
        </div>
    </div>

    <script>
        // Check JavaScript
        document.querySelector('.no-js').style.display = 'none';

        // Load public bots
        async function loadPublicBots() {
            const response = await fetch('/api/bots');
            const data = await response.json();
            const grid = document.getElementById('publicBotsGrid');
            grid.innerHTML = '';

            if (data.success) {
                if (data.bots.length === 0) {
                    grid.innerHTML = '<p>No OGsbot bots found.</p>';
                } else {
                    data.bots.forEach(bot => {
                        const card = document.createElement('div');
                        card.className = 'bot-card';
                        card.innerHTML = `
                            <div class="bot-avatar" style="background-image: url('https://via.placeholder.com/80?text=${bot.nickname.charAt(0)}')"></div>
                            <h4>${bot.nickname}</h4>
                            <p>Status: BOOTING</p>
                            <p>96 FRIENDS</p>
                        `;
                        grid.appendChild(card);
                    });
                }
            } else {
                grid.innerHTML = `<p>Error: ${data.error}</p>`;
            }
        }

        // Load categories
        async function loadCategories() {
            const response = await fetch('/api/categories');
            const data = await response.json();
            const categoryList = document.getElementById('categoryList');
            categoryList.innerHTML = '';

            if (data.success) {
                data.categories.forEach(category => {
                    const div = document.createElement('div');
                    div.className = 'category-card';
                    div.innerHTML = `
                        <span class="category-name">${category.name} (0 of 0 bots)</span>
                        <div class="category-actions">
                            <button class="settings-btn" onclick="showSettings('${category.id}')">⚙️</button>
                            <button class="add-bot-btn" onclick="openAddBotModal('${category.id}')">+</button>
                        </div>
                        <div id="settings-${category.id}" class="settings"></div>
                    `;
                    categoryList.appendChild(div);
                });
            } else {
                categoryList.innerHTML = `<p>Error loading categories: ${data.error}</p>`;
            }
        }

        // Epic Games flows in modal
        function createEpicAccount() {
            alert('Please do not add this to your main account as this may cause major issues with your main account. Please login to an alt account on Epic Games before proceeding with this step.');
        }

        function redirectToEpic() {
            window.location.href = 'https://www.epicgames.com/id/api/redirect?clientId=3f69e56c7649492c8cc29f1af08a8a12&responseType=code';
        }

        // Handle modal and form after redirect
        function openAddBotModal(categoryId) {
            document.getElementById('selectedCategoryId').value = categoryId;
            document.getElementById('addBotModal').style.display = 'block';
            document.getElementById('epicIdField').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'none';
        }

        function closeModal() {
            document.getElementById('addBotModal').style.display = 'none';
            document.getElementById('epicIdField').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'none';
        }

        // Check for redirect code and enable form
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('code')) {
                document.getElementById('epicIdField').style.display = 'block';
                document.getElementById('submitBtn').style.display = 'inline-block';
            }
            loadPublicBots();
            loadCategories();
        };

        // Add Bot Form Submit
        document.getElementById('addBotForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const epicId = document.getElementById('epicId').value;
            const botName = document.getElementById('botName').value;
            const categoryId = document.getElementById('selectedCategoryId').value;

            const response = await fetch('/api/register-bot', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ epicId, altAccount: 'defaultAlt', botName, categoryId }) // Placeholder altAccount
            });

            const data = await response.json();
            const display = document.getElementById('botDisplay');
            if (data.success) {
                display.innerHTML = `
                    <h3>Bot "${data.bot.nickname}" added to category ${data.bot.categoryId}</h3>
                    <p>Epic ID: ${data.bot.epicId}</p>
                    <p>Simulating AHK: epicId=${epicId}, botName=${botName}, categoryId=${categoryId}</p>
                `;
                closeModal();
            } else {
                display.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
            }
        });

        // Settings button
        async function showSettings(categoryId) {
            const settingsDiv = document.getElementById(`settings-${categoryId}`);
            if (settingsDiv.style.display === 'block') {
                settingsDiv.style.display = 'none';
                return;
            }

            const response = await fetch(`/api/category-settings?categoryId=${categoryId}`);
            const data = await response.json();

            if (data.success && categoryId === '67c2fd571906bd75e5239684') {
                const category = data.category;
                settingsDiv.innerHTML = `
                    <h4>Settings for ${category.name}</h4>
                    <p><strong>ID:</strong> ${category.id}</p>
                    <p><strong>Admins:</strong> ${category.config.admins.map(a => a.name).join(', ')}</p>
                    <p><strong>Privacy:</strong> ${category.config.privacy}</p>
                    <p><strong>Accept Invites:</strong> ${category.config.acceptInvites}</p>
                    <p><strong>Disable Playlist Checks:</strong> ${category.config.disablePlaylistChecks}</p>
                    <p><strong>Platform:</strong> ${category.config.platform.join(', ')}</p>
                    <p><strong>Invite Timeout:</strong> ${category.config.inviteTimeout}</p>
                    <p><strong>Level:</strong> ${category.config.level.join(', ')}</p>
                    <p><strong>Start Outfits:</strong> ${category.config.startOutfit.map(o => `${o.id} (Variants: ${o.variants.join(', ')})`).join('<br>')}</p>
                    <p><strong>Prefixes:</strong> ${category.config.prefixes.join(', ')}</p>
                `;
                settingsDiv.style.display = 'block';
            } else {
                settingsDiv.innerHTML = `<p>Error: Settings only available for category ID 67c2fd571906bd75e5239684</p>`;
                settingsDiv.style.display = 'block';
            }
        }

        // Placeholder functions
        function viewLogs() { console.log('View logs clicked'); }
        function stopBots() { console.log('Stop bots clicked'); }
        function startBots() { console.log('Start bots clicked'); }
        function sortBots() { console.log('Sort clicked'); }
    </script>
</body>
</html>
